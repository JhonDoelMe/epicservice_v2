
### Технічна документація «Епік-сервіс» (Розширена версія)

Цей документ надає поглиблений технічний огляд Telegram-бота «Епік-сервіс», призначений для розробників та адміністраторів системи.

---

### 1. Архітектура та Технологічний стек

Бот побудований на асинхронному фреймворку **Aiogram 3.x**, що забезпечує високу продуктивність при обробці великої кількості одночасних запитів. Взаємодія з базою даних **PostgreSQL** реалізована через **SQLAlchemy 2.x** з використанням асинхронного драйвера `asyncpg` для основної логіки та синхронного `psycopg2` для міграцій та фонових завдань.

#### 1.1. Технологічний стек
* **Мова:** Python 3.10+
* **Фреймворк для бота:** Aiogram 3.x
* **База даних:** PostgreSQL
* **ORM:** SQLAlchemy 2.x (`asyncpg` + `psycopg2`)
* **Міграції БД:** Alembic
* **Робота з файлами:** Pandas, Openpyxl, aiofiles
* **Нечіткий пошук:** `thefuzz`
* **Змінні оточення:** `python-dotenv`

---

### 2. Структура проєкту

Проєкт має модульну структуру, що розділяє відповідальність між компонентами системи.

* `alembic/`: Скрипти міграцій бази даних.
* `database/`: Модулі для роботи з БД.
    * `engine.py`: Налаштування асинхронного та синхронного підключення.
    * `models.py`: Декларативні моделі таблиць SQLAlchemy.
    * `orm/`: Шар доступу до даних (Object-Relational Mapping), що інкапсулює всю логіку SQL-запитів. `__init__.py` збирає всі функції для зручного імпорту.
* `handlers/`: Обробники повідомлень та callback-запитів, розділені на `admin/` та `user/` для розмежування доступу.
* `keyboards/`: Фабрики для створення динамічних Inline-клавіатур.
* `lexicon/`: Централізоване сховище всіх текстових констант, що спрощує редагування та локалізацію.
* `middlewares/`: Проміжне ПЗ. `LoggingMiddleware` збагачує логи контекстом (user_id, update_id), що є критично важливим для налагодження.
* `utils/`: Допоміжні функції, що містять ключову бізнес-логіку.
* `bot.py`: Головний файл, точка входу, що ініціалізує та запускає всі компоненти.
* `config.py`: Керування конфігурацією через змінні оточення.

---

### 3. Схема Бази Даних

База даних спроєктована для ефективного зберігання інформації про користувачів, товари та їхні списки.

* **`User`**: Зберігає базову інформацію про користувачів Telegram (`id`, `username`, `first_name`).
* **`Product`**: Основна таблиця каталогу товарів. Містить поля для артикула, назви, відділу, групи, кількості, а також розраховані поля, як-от ціна та сума залишку. Поле `активний` використовується для "м'якого видалення".
* **`TempList`**: Таблиця для тимчасових (незбережених) списків. Кожен запис — це товар (`product_id`) у списку конкретного користувача (`user_id`) із зазначенням кількості. Ця таблиця є джерелом для розрахунку резервів "на льоту".
* **`SavedList`**: Зберігає мета-інформацію про збережені списки (хто зберіг, ім'я файлу, шлях до нього, дата створення).
* **`SavedListItem`**: Зберігає позиції, що увійшли до конкретного збереженого списку. Використовується для формування зведених звітів.

---

### 4. Ключові бізнес-процеси

#### 4.1. "Розумний" імпорт товарів (`orm_smart_import`)
Це центральна функція для оновлення каталогу, яка виконується синхронно для обробки DataFrame з Pandas.

1.  **Валідація:** Перевіряється наявність обов'язкових колонок (`в, г, н, к`) у файлі Excel.
2.  **Підготовка даних:** Дані з файлу нормалізуються: витягуються артикули, числові значення приводяться до єдиного формату, розраховується ціна, якщо вона не вказана.
3.  **Синхронізація:**
    * **Додавання:** Артикули, що є у файлі, але відсутні в БД, додаються як нові товари.
    * **Оновлення:** Дані для артикулів, що є і у файлі, і в БД, оновлюються. Якщо товар був неактивним, він повторно активується.
    * **Деактивація:** Артикули, що є в БД, але відсутні у файлі, позначаються як `активний=False` ("м'яке видалення").
4.  **Очищення резервів:** Поле `відкладено` для всіх товарів обнуляється.
5.  **Результат:** Функція повертає словник зі статистикою (додано, оновлено, деактивовано), який використовується для звіту адміністратору та розсилки користувачам.

#### 4.2. Процес збереження списку (`process_and_save_list`)
Ця функція забезпечує атомарне збереження списку користувача та оновлення залишків.

1.  **Отримання даних:** Функція отримує тимчасовий список користувача з `TempList`.
2.  **Аналіз залишків:** В межах транзакції для кожної позиції списку блокується запис у таблиці `Product` (`FOR UPDATE`), щоб уникнути "гонки" даних. Розраховується доступна кількість, враховуючи постійний резерв (`відкладено`).
3.  **Розподіл на списки:**
    * Якщо товару вистачає, він потрапляє до основного списку.
    * Якщо товару не вистачає, доступна частина йде в основний список, а дефіцит ("лишки") — у список надлишків.
4.  **Оновлення резервів:** Кількість товарів з основного списку додається до поля `відкладено` у таблиці `Product`.
5.  **Збереження файлів:** Списки зберігаються у `.xlsx` файли з унікальними іменами.
6.  **Збереження в архів:** Інформація про основний список записується в таблиці `SavedList` та `SavedListItem`.
7.  **Очищення:** Тимчасовий список користувача повністю очищується.

#### 4.3. Керування станами (FSM)
Бот активно використовує машину скінченних станів (FSM) `aiogram` для керування багатоетапними сценаріями.
* **Приклад:** Редагування списку. Коли користувач натискає "Редагувати", бот переходить у стан `ListEditingStates.editing_list`. При виборі товару — у стан `waiting_for_new_quantity`, очікуючи на повідомлення з новою кількістю. Це дозволяє ізолювати логіку та уникати конфліктів між обробниками.
* Аналогічні механізми використовуються для імпорту файлів, віднімання залишків та підтвердження дій.

---

### 5. Інструкція з розгортання та обслуговування

1.  **Клонуйте репозиторій** та перейдіть до папки проєкту.
2.  **Створіть та активуйте віртуальне оточення** (`python3 -m venv venv && source venv/bin/activate`).
3.  **Встановіть залежності:** `pip install -r requirements.txt`.
4.  **Створіть файл `.env`** у кореневій папці та заповніть його, вказавши `BOT_TOKEN`, дані для підключення до PostgreSQL та `ADMIN_IDS`.
5.  **Налаштуйте Alembic:** У файлі `alembic.ini` вкажіть **синхронну** строку підключення до БД у `sqlalchemy.url`.
6.  **Застосуйте міграції** для створення таблиць: `alembic upgrade head`.
7.  **Запустіть бота:** `python3 bot.py`.
8.  **Логування:** Бот веде детальний лог у файл `bot.log` та виводить інформацію в консоль. Рекомендується налаштувати ротацію логів для запобігання переповненню диска.
9.  **Резервне копіювання:** Регулярно створюйте резервні копії бази даних PostgreSQL та директорії `archives/`, де зберігаються згенеровані файли.